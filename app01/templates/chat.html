{% extends 'layout.html' %}

{% block content %}
    <style>
        .navbar {
            margin-bottom: 0 !important;
        }

        .container-fluid1 {
            display: flex;
            height: 90vh; /* Use viewport height to fill the screen */
        }

        .left-bar {
            height: 90vh;
            background-color: #053354;
            flex: 0 0 30%; /* Assign width to left bar and prevent it from growing or shrinking */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align items to the top */
            padding-top: 20px;
        }

        .right-bar {
            flex: 1;
            background-color: white;
            height: 90vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 20px;
            overflow-y: auto;
            border: 1px solid #ccc;
        }

        .function-bar {
            display: flex;
            justify-content: space-between; /* Aligns items on both ends */
            align-items: center;
            padding: 0 20px; /* Add padding on sides */
            width: 100%;
        }

        .function-bar img.avatar {
            height: 60px; /* Size of the avatar */
            width: 60px; /* To keep the avatar circular */
            border-radius: 50%;
            border: 2px solid white;
            margin-right: auto; /* Push all other items to the right */
        }


        .icon {
            height: 40px; /* Adjust icon size */
            {#filter: invert(100%); /* Invert colors for white icons */#}
        }

        .search-bar {
            background-color: white;
            border-radius: 20px;
            margin: 20px; /* Added margin to all sides */
            padding: 5px 15px; /* Padding inside search bar */
        }

        .search-bar input {
            width: 90%;
            border: none;
            outline: none; /* Removes focus outline */
        }


        .search-bar input::placeholder {
            color: #a1a1a1;
        }


        .input-group {
            position: relative;
            bottom: 0;
            left: 0;
            width: 100%; /* 或根据需要设置具体宽度 */
        }

        .message-wrapper {
            display: flex;
            justify-content: flex-start; /* 默认对齐方式 */
            width: 100%;
            margin-bottom: 10px;
        }

        .sender-message-wrapper {
            justify-content: flex-end; /* 发送者消息靠右对齐 */
        }

        .message {
            padding: 10px;
            border-radius: 10px;
            display: inline-block; /* 根据内容调整宽度 */
            background-color: #e0e0e0; /* 默认背景色 */
            color: black; /* 默认文字颜色 */
            word-wrap: break-word;
        }

        .sender-message {
            background-color: #16C55E;
            color: black;
            text-align: right;
        }

        .receiver-message {
            background-color: #e0e0e0;
            color: black;
            text-align: left;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            align-self: center; /* 对齐调整为居中，以便于在wrapper内的位置调整 */
        }

        /* 发送者头像的外边距调整 */

        .sender-avatar {
            margin-left: 10px;
        }

        /* 接收者头像的外边距调整 */

        .receiver-avatar {
            margin-right: 10px;
        }


        .sender-message-wrapper, .receiver-message-wrapper {
            display: flex;
            align-items: flex-end;
        }

        #avatar {
            height: 50px;
            width: 50px;
            border-radius: 50%;
            border: 2px solid grey;
        }

        #icon {
            height: 30px;
        }

    </style>
    <div class="container-fluid1">
        <div class="left-bar">
            <div class="function-bar">
                <img class="avatar" src="{{ current_avatar_url }}" id="avatar"> <!-- Avatar is now aligned left -->
                <!-- Icons aligned right -->
                <img class="icon" src="/media/add_friend.png" id="icon"> <!-- Replace with actual image source -->
            </div>
            <div class="search-bar">
                <input type="text" placeholder="Search or start new chat">
            </div>
            <!-- Chat list goes here -->
        </div>


        <div class="right-bar">
            <div id="message-container" style="padding: 20px; overflow-y: auto;">
            </div>

            <div class="input-group">
                <input type="text" class="form-control" id="txt" placeholder="Type a message">
                <span class="input-group-btn">
            <button class="btn btn-default" type="button" onclick="sendMessage()">Send</button>
            </span>
            </div>
        </div>
    </div>


    <script>
        var currentUser = "{{ current_username }}";
        var targetUser = "{{ target_username }}";

        console.log("Current User:", "{{ current_username }}");
        console.log("Target User:", "{{ target_username }}");

        // 按字典序排序用户名
        var roomName = [currentUser, targetUser].sort().join('_');
        var wsPath = `ws://127.0.0.1:8000/ws/chat/${roomName}/`;
        var socket = new WebSocket(wsPath);

        socket.onopen = function (e) {
            console.log("连接成功");
        };

        socket.onmessage = function (e) {
            var data = JSON.parse(e.data);
            if (data.sender === currentUser) {
                return;
            }

            var messageContainer = document.getElementById("message-container");
            var wrapperElement = document.createElement("div");
            wrapperElement.classList.add("message-wrapper");

            // 添加头像
            var avatarElement = document.createElement("img");
            avatarElement.src = "{{ target_avatar_url }}"; // 替换为实际的头像URL
            avatarElement.classList.add("avatar");
            wrapperElement.appendChild(avatarElement);

            var messageElement = document.createElement("div");
            messageElement.classList.add("message", "receiver-message");
            messageElement.textContent = data.message;
            wrapperElement.appendChild(messageElement);

            messageContainer.appendChild(wrapperElement);
        };


        function sendMessage() {
            var txtInput = document.getElementById("txt");
            var message = txtInput.value.trim();

            if (!message) {
                return;
            }

            var messageContainer = document.getElementById("message-container");
            var wrapperElement = document.createElement("div");
            wrapperElement.classList.add("message-wrapper", "sender-message-wrapper");

            var messageElement = document.createElement("div");
            messageElement.classList.add("message", "sender-message");
            messageElement.textContent = message;
            wrapperElement.appendChild(messageElement);

            // 添加头像，但这次是在消息文本之后，以确保它出现在右侧
            var avatarElement = document.createElement("img");
            avatarElement.src = "{{ current_avatar_url }}"; // 替换为实际的头像URL
            avatarElement.classList.add("avatar", "sender-avatar");
            wrapperElement.appendChild(avatarElement);

            messageContainer.appendChild(wrapperElement);

            socket.send(JSON.stringify({'message': message, 'sender': currentUser}));

            txtInput.value = "";
        }

        document.getElementById("txt").addEventListener("keypress", function (event) {
            // 检查是否按下了Enter键
            if (event.key === "Enter") {
                event.preventDefault(); // 阻止默认行为（不插入换行符）
                sendMessage(); // 调用发送消息的函数
            }
        });

    </script>


{% endblock %}